<?php
 defined('IN_IA')or exit('Access Denied');global $_W, $_GPC;$_W['page']['title'] ='计划任务-' . $_W['we7_wmall']['config']['title'];mload()->model('store');$store =store_check();$sid =$store['id'];$do ='cron';$op =trim($_GPC['op']);if($op == 'order_notice'){if(!$store['pc_notice_status']){exit('error');}$order =pdo_fetch('SELECT id FROM ' . tablename('tiny_wmall_order'). ' WHERE uniacid = :uniacid AND sid = :sid and status = 1 ORDER BY id asc', array(':uniacid' => $_W['uniacid'], ':sid' => $sid));if(!empty($order)){exit('success');}exit('error');}if($op == 'order_print'){mload()->model('print');$data =pdo_fetchall('SELECT a.*, b.print_no, b.key, b.member_code FROM ' . tablename('tiny_wmall_order_print_log'). ' AS a LEFT JOIN '.tablename('tiny_wmall_printer').' AS b ON a.pid = b.id WHERE a.uniacid = :aid AND a.sid = :sid AND a.status = 2 ORDER BY addtime ASC LIMIT 10', array(':aid' => $_W['uniacid'], ':sid' => $sid));if(!empty($data)){foreach($data as $da){if(!empty($da['foid'])&& !empty($da['print_no'])){$status =print_query_order_status($da['printer_type'], $da['print_no'], $da['key'], $da['member_code'], $da['foid']);if($status == 1){pdo_update('tiny_wmall_order_print_log', array('status' => $status), array('uniacid' => $_W['uniacid'], 'sid' => $sid, 'foid' => $da['foid']));}}}}}
?>